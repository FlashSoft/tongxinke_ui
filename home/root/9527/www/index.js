const baseUrl='http://'+window.location.hostname+':9527/';let socThmZoneValue=0;let imei='';let iccid='';layui.use(function(){var element=layui.element;var table=layui.table;var form=layui.form;var currentPage=1;var limit=10;function fetchSMSData(){fetch(baseUrl+'api/sms/getsms',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({page:currentPage,limit:limit}),}).then((response)=>response.json()).then((data)=>{const totalCount=data.count||0;const totalPages=Math.ceil(totalCount/limit);document.getElementById('smsCount').innerText='条数: '+totalCount;document.getElementById('totalPages').innerText='页数: '+totalPages;document.getElementById('itemsPerPage').innerText='每页: '+limit;const pageSelect=document.getElementById('pageSelect');pageSelect.innerHTML='';for(let i=1;i<=totalPages;i++){const option=document.createElement('option');option.value=i;option.textContent=i;pageSelect.appendChild(option);}
pageSelect.value=currentPage;layui.form.render('select');function renderTable(smsData){table.render({elem:'#smsTable',data:smsData,page:false,cols:[[{type:'checkbox',width:'3%',minWidth:50},{field:'content',title:'内容',width:'50%',minWidth:200,},{field:'sender',title:'发件人',width:'24%',minWidth:100,},{field:'sent_time',title:'时间',width:'23%',minWidth:150,templet:function(d){return d.sent_time?new Date(d.sent_time).toLocaleString():'-';},},],],});}
renderTable(totalCount>0?data.sms:[]);document.getElementById('prevPage').disabled=currentPage===1;document.getElementById('nextPage').disabled=currentPage*limit>=totalCount;}).catch((error)=>{console.error('短信数据请求失败:',error);});}
let btns=document.querySelectorAll('#atcommand-btns button');if(btns){btns.forEach(item=>{item.onclick=function(){let atcmd=item.innerText.split('：')[1];document.getElementById('atCommandInput').value=atcmd;}})}
function fetchConfigData(){fetch(baseUrl+'api/sms/forward/getconfig').then((response)=>response.json()).then((data)=>{if(data){document.getElementById('pushplus_forward').checked=data.pushplus.pushplus_forward===1;document.getElementById('pushplus_channel').value=data.pushplus.pushplus_channel;document.getElementById('pushplus_token').value=data.pushplus.pushplus_token;document.getElementById('pushplus_channel_code').value=data.pushplus.pushplus_channel_code;document.getElementById('sms_forward').checked=data.sms.sms_forward===1;document.getElementById('to_num').value=data.sms.to;form.render();}}).catch((error)=>{console.error('fetchConfigData err',error);});}
function fetchForwardLogs(){fetch(baseUrl+'api/sms/forward/getlogs').then((response)=>{if(!response.ok){throw new Error('Network response was not ok');}
return response.text();}).then((data)=>{const logTextarea=document.getElementById('logTextarea');logTextarea.value=data;}).catch((error)=>{console.error('fetchForwardLogs err:',error);});}
function deleteForwardLogs(){fetch(baseUrl+'api/sms/forward/deletelogs',{method:'GET',}).then((response)=>response.json()).then((data)=>{if(data.success===0){layer.msg('日志删除成功');fetchForwardLogs();}else{layer.msg('日志删除失败');}}).catch((error)=>{console.error('deleteForwardLogs err:',error);});}
function fetchTempData(){fetch(baseUrl+'api/sys/temp').then((response)=>response.json()).then((data)=>{const thermalZones=data.temp;const tempTableBody=document.getElementById('tempTableBody');tempTableBody.innerHTML='';Object.entries(thermalZones).forEach(([key,value])=>{let temp=(value/1000).toFixed(2);let percent=temp;if(temp>100){percent=100;}
if(key.includes('soc-thmzone')){socThmZoneValue=temp;}
const row=document.createElement('tr');row.innerHTML=`<td>${key}</td>
                            <td><span class="temp-indicator">${temp}°C <div class="temp-bar"><div class="temp-fill" style="width: ${percent}%"></div></div></span></td>`;tempTableBody.appendChild(row);});document.getElementById('temperature').innerHTML=socThmZoneValue+' °C';}).catch((error)=>{console.error('fetchTempData err',error);});}
function fetchNetwork(){fetch('http://'+window.location.hostname+':8080/api/get/network').then((response)=>response.json()).then((data)=>{if(!data.Data){return;}
let networks=data.Data.Network;let networkTableBody=document.getElementById('networkTableBody');networkTableBody.innerHTML='';for(let network of networks){const row=document.createElement('tr');row.innerHTML=`<td>${network.Band}</td><td>${network.ARFCN}</td><td>${network.PCI}</td><td>${network.RSRP}</td><td>${network.RSRQ}</td><td>${network.SINR}</td>`;networkTableBody.appendChild(row);}
if(networks.length){document.getElementById('Band').innerHTML=networks[0].Band;document.getElementById('ARFCN').innerHTML=networks[0].ARFCN;document.getElementById('PCI').innerHTML=networks[0].PCI;const rsrpValue=networks[0].RSRP;document.getElementById('RSRP').innerHTML=rsrpValue+' dBm';updateRSRPDisplay(rsrpValue);let rsrqPercent=calcPercent(networks[0].RSRQ,-19,-3)
document.getElementById('rsrq-text').innerText=networks[0].RSRQ;document.getElementById('rsrq-bar').style.width=`${rsrqPercent}%`;let sinrPercent=calcPercent(networks[0].SINR,-13,20)
document.getElementById('sinr-text').innerText=networks[0].SINR;document.getElementById('sinr-bar').style.width=`${sinrPercent}%`;}
let technology=data.Data.Technology;if(technology=='lte'){technology=`<span class="network-type"><span class="network-primary">4G</span><span class="network-secondary">LTE</span></span>`;}else{technology=`<span class="network-type"><span class="network-primary">5G</span><span class="network-secondary">${technology.toUpperCase()}</span></span>`;}
document.getElementById('technology').innerHTML=technology;document.getElementById('technology2').innerHTML=technology;}).catch((error)=>{console.error('fetchNetwork err',error);});}
function sendSMS(){const toNum=document.getElementById('ToNumInput').value;const textContent=document.getElementById('Text_Content').value;if(!toNum||!textContent){layer.msg('请填写收件人和短信内容！');return;}
layer.msg('正在发送短信...');const payload={to:toNum,text:textContent,};fetch(baseUrl+'api/sms/send',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify(payload),}).then((response)=>response.json()).then((data)=>{if(data.success){layer.msg('发送成功');}else{layer.msg('发送失败：'+data.msg);}}).catch((error)=>{console.error('sendSMS err:',error);});}
document.getElementById('sendSMSBtn').onclick=sendSMS;function deletLogs(){layer.confirm('确定要删除转发日志吗？',{icon:3,title:'确认'},function(index){deleteForwardLogs();layer.close(index);});}
document.getElementById('deleteLogsButton').addEventListener('click',deletLogs);document.getElementById('pageSelect').addEventListener('change',function(){currentPage=parseInt(this.value);fetchSMSData();});document.getElementById('limitSelect').addEventListener('change',function(){limit=parseInt(this.value);fetchSMSData();});document.getElementById('deleteSelected').onclick=function(){var checkStatus=table.checkStatus('smsTable');var selectedIds=checkStatus.data.map((item)=>item.id);if(selectedIds.length===0){layer.msg('请先选择要删除的短信。');return;}
layer.confirm('确认删除选中信息？',{icon:3,btn:['确定','取消'],},function(){fetch(baseUrl+'api/sms/delete',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({ids:selectedIds}),}).then((response)=>response.json()).then((data)=>{if(data.success){layer.msg('删除成功！');currentPage=1;fetchSMSData();}else{layer.msg('删除失败。');}}).catch((error)=>{console.error('Error deleting SMS:',error);});},function(){layer.msg('删除取消。');});};document.getElementById('delete_SMS_DB').onclick=function(){layer.confirm('确认清空所有信息？',{icon:3,btn:['确定','取消'],},function(){fetch(baseUrl+'api/sms/delete/smsdb',{method:'GET',}).then((response)=>response.json()).then((data)=>{if(data.success===0){layer.msg('短信清空成功');}else{layer.msg('短信清空失败');}
fetchSMSData();}).catch((error)=>{console.error('delete_SMS_DB err:',error);});},function(){layer.msg('取消。');});};document.getElementById('refreshData').onclick=function(){fetchSMSData();layer.msg('已刷新');};document.getElementById('prevPage').onclick=function(){if(currentPage>1){currentPage--;fetchSMSData();}};document.getElementById('nextPage').onclick=function(){currentPage++;fetchSMSData();};document.getElementById('sendAtCommandBtn').onclick=function(){const commandInput=document.getElementById('atCommandInput').value;const responseBox=document.getElementById('atCommandResponse');if(commandInput===''){layer.msg('请输入一个 AT 命令！');return;}
const requestData={cmd:commandInput,};fetch(baseUrl+'api/at',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify(requestData),}).then((response)=>response.text()).then((data)=>{responseBox.value=commandInput+'\n'+data+'\n'+responseBox.value;}).catch((error)=>{console.error('Error sending AT command:',error);responseBox.value=commandInput+'\n'+'发送失败：'+
error+'\n'+
responseBox.value;});};fetchTempData();fetchNetwork();fetchSMSData();fetchConfigData();fetchForwardLogs();sysinfo();getIMEI();setInterval(function(){fetchTempData();fetchNetwork();fetchForwardLogs();sysinfo();if(!imei||!iccid){getIMEI();}},3000);setInterval(function(){getIMEI();},1000*60);form.on('submit(saveConfig)',function(){var smsForwardToken=document.getElementById('pushplus_token').value;var smsForwardChannelCode=document.getElementById('pushplus_channel_code').value;var smsForwardChannel=document.getElementById('pushplus_channel').value;var to_num=document.getElementById('to_num').value;if(smsForwardChannel==='webhook'&&smsForwardChannelCode.trim()===''){layer.msg('选择webhook时渠道编码不能为空！');return false;}
var configData={pushplus_forward:document.getElementById('pushplus_forward').checked?1:0,pushplus_channel:smsForwardChannel,pushplus_token:smsForwardToken,pushplus_channel_code:smsForwardChannelCode,sms_forward:document.getElementById('sms_forward').checked?1:0,to:to_num,};fetch(baseUrl+'api/sms/forward/setconfig',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify(configData),}).then((response)=>response.json()).then((data)=>{if(data.success){layer.msg('保存配置成功');}else{layer.msg('保存配置失败');}}).catch((error)=>{console.error('saveConfig err:',error);});return false;});});function calcPercent(value,min,max){value=Number(value);min=Number(min);max=Number(max);if(min>=max){console.warn('calcPercent: 最小值必须小于最大值');return 0;}
if(value<=min)return 0;if(value>=max)return 100;return Math.round(((value-min)/(max-min))*100);}
function updateRSRPDisplay(rsrpValue){const rsrp=parseInt(rsrpValue);let percentage=calcPercent(rsrp,-120,-70);let quality='';let qualityClass='';if(percentage>80){quality='好';qualityClass='signal-quality-excellent';}else if(percentage>60){quality='较好';qualityClass='signal-quality-good';}else if(percentage>=40){quality='一般';qualityClass='signal-quality-good';}else if(percentage>=20){quality='较差';qualityClass='signal-quality-fair';}else{quality='极差';qualityClass='signal-quality-poor';}
const barElement=document.getElementById('rsrp-bar');const qualityElement=document.getElementById('rsrp-quality');if(barElement){barElement.style.width=`${percentage}%`;barElement.classList.remove('signal-bar-excellent','signal-bar-good','signal-bar-fair','signal-bar-poor');if(percentage>=80){barElement.classList.add('signal-bar-excellent');}else if(percentage>=60){barElement.classList.add('signal-bar-good');}else if(percentage>=40){barElement.classList.add('signal-bar-fair');}else{barElement.classList.add('signal-bar-poor');}}
if(qualityElement){qualityElement.textContent=`${rsrpValue}dBm ${quality}`;qualityElement.classList.remove('signal-quality-excellent','signal-quality-good','signal-quality-fair','signal-quality-poor');qualityElement.classList.add(qualityClass);}}
function getIMEI(){const requestData={cmd:'AT+CGSN',};fetch(baseUrl+'api/at',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify(requestData),}).then((response)=>response.text()).then((data)=>{imei=data.replace(/[^\d]/g,'');document.getElementById('imei').innerHTML=imei;getICCID();}).catch((error)=>{console.error('Error getIMEI:',error);getICCID();});}
function getICCID(){const requestData={cmd:'AT+CCID',};fetch(baseUrl+'api/at',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify(requestData),}).then((response)=>response.text()).then((data)=>{let result=data.match(/"([^"]*)"/);if(result){iccid=result[1];getISP(iccid);document.getElementById('simStatus').innerHTML='✓ 已插卡';}else{iccid='';document.getElementById('simStatus').innerHTML='--';}
document.getElementById('iccid').innerHTML=iccid;}).catch((error)=>{console.error('Error getICCID:',error);});}
function getISP(iccid){if(iccid.startsWith('898600')||iccid.startsWith('898602')||iccid.startsWith('898604')||iccid.startsWith('898607')){document.getElementById('ISP').innerHTML='中国移动';}else if(iccid.startsWith('898601')||iccid.startsWith('898606')||iccid.startsWith('898609')){document.getElementById('ISP').innerHTML='中国联通';}else if(iccid.startsWith('898603')||iccid.startsWith('898611')){document.getElementById('ISP').innerHTML='中国电信';}else if(iccid.startsWith('898615')){document.getElementById('ISP').innerHTML='中国广电';}else{document.getElementById('ISP').innerHTML='未知';}}
function sysinfo(){fetch(baseUrl+'api/sysinfo').then((response)=>{if(!response.ok){throw new Error('Network response was not ok');}
return response.json();}).then((data)=>{let totalMemoryMB=(data.sys.total_memory/(1024*1024)).toFixed(2);let freeMemoryMB=(data.sys.free_memory/(1024*1024)).toFixed(2);let memoryPercent=calcPercent(freeMemoryMB,0,totalMemoryMB);document.getElementById('memory-text').innerHTML=`${freeMemoryMB} / ${totalMemoryMB} MB`;document.getElementById('memory-bar').style.width=`${memoryPercent}%`;const uptime=data.sys.uptime;const days=Math.floor(uptime/86400);const hours=Math.floor((uptime%86400)/3600);const minutes=Math.floor((uptime%3600)/60);let t='';if(days){t+=days+' 天 ';}
if(hours){t+=hours+' 时 ';}
t+=minutes+' 分';document.getElementById('uptime').innerHTML=t;document.getElementById('ver').innerHTML=data.sys.ver;document.getElementById('kernel_version').innerHTML=data.sys.kernel_version;document.getElementById('qci').innerHTML=data.ambr.qci;document.getElementById('dl').innerHTML=data.ambr.dl/1000+' Mbps';document.getElementById('ul').innerHTML=data.ambr.ul/1000+' Mbps';if(data.ambr.qci){document.getElementById('networkStatus').innerHTML=`✓ 已联网`;}else{document.getElementById('networkStatus').innerHTML=`<span style="color: #e74c3c">× 疑似断网</span>`;}}).catch((error)=>{console.log('sysinfo err:',error);});}
function base64ToUtf8(base64Str){const binaryStr=atob(base64Str);const len=binaryStr.length;const bytes=new Uint8Array(len);for(let i=0;i<len;i++){bytes[i]=binaryStr.charCodeAt(i);}
const utf8Str=new TextDecoder('utf-8').decode(bytes);return utf8Str;}